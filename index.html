<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <link href="style.css" type="text/css" rel="stylesheet">
  </head>
  <body>
    <div class="grid">
      <div class="game-board">
	<canvas id="board"></canvas>
      </div>
      <div class="peg-board">
	<canvas id="pboard"></canvas>
      </div>
      <div class = "pegs">
	<canvas id="redpeg" class="peg"></canvas>
	<canvas id="bluepeg1" class="peg"></canvas>
	<canvas id="bluepeg2" class="peg"></canvas>
	<canvas id="greenpeg1" class="peg"></canvas>
	<canvas id="greenpeg2" class="peg"></canvas>
	<canvas id="yellowpeg1" class="peg"></canvas>
	<canvas id="yellowpeg2" class="peg"></canvas>
      </div>
      <div class = "peglocs">
	<input id="pegcmdred" type="text" class="pegcmd">
	<input id="pegcmdblue1" type="text" class="pegcmd">
	<input id="pegcmdblue2" type="text" class="pegcmd">
	<input id="pegcmdgreen1" type="text" class="pegcmd">
	<input id="pegcmdgreen2" type="text" class="pegcmd">
	<input id="pegcmdyellow1" type="text" class="pegcmd">
	<input id="pegcmdyellow2" type="text" class="pegcmd">
      </div>
      
      <div>
	<button onclick="placePegs()" class="place-pegs">Place Pegs</button>
      </div>
      
      <div class = "solving">
	Solution <input id="solutionIdx" type="text" value="1"> of <span id="nsolutions">....</span>
	<button onclick="solve()" class="solve">Solve</button>
      </div>

      <span id="rowA" class="rowlabel">A</span>
      <span id="rowB" class="rowlabel">B</span>
      <span id="rowC" class="rowlabel">C</span>
      <span id="rowD" class="rowlabel">D</span>
      
      <span id="col1" class="collabel">1</span>
      <span id="col2" class="collabel">2</span>
      <span id="col3" class="collabel">3</span>
      <span id="col4" class="collabel">4</span>
      <span id="col5" class="collabel">5</span>
      <span id="col6" class="collabel">6</span>
      <span id="col7" class="collabel">7</span>
      <span id="col8" class="collabel">8</span>
      
    </div>
 
    <script>

      const COLS = 8;
      const ROWS = 4;
      const BLOCK_SIZE = 50;
      
      // Init Board
      const canvas = document.getElementById('board');
      const ctx = canvas.getContext('2d');

      ctx.canvas.width = COLS * BLOCK_SIZE;
      ctx.canvas.height = ROWS * BLOCK_SIZE;
      ctx.scale(BLOCK_SIZE, BLOCK_SIZE)

      const pcanvas = document.getElementById('pboard');
      const pctx = pcanvas.getContext('2d');

      pctx.canvas.width = COLS * BLOCK_SIZE;
      pctx.canvas.height = ROWS * BLOCK_SIZE;
      pctx.scale(BLOCK_SIZE, BLOCK_SIZE)

      // Init pegs
      let pegs = document.getElementsByClassName("peg");
      var x = 0;
      for (var i = 0; i < pegs.length; i++) {
	  let peg = pegs[i];
	  let ctxPeg = peg.getContext("2d");
	  ctxPeg.canvas.width = COLS * BLOCK_SIZE;
	  ctxPeg.canvas.height = ROWS * BLOCK_SIZE;
	  
	  if (peg.id.includes("red") ) {
	      ctxPeg.fillStyle = "red";
	  }
	  else if (peg.id.includes("blue")) {
	      ctxPeg.fillStyle = "blue";
	  }
	  else if (peg.id.includes("green")) {
	      ctxPeg.fillStyle = "green";
	  }
	  else if (peg.id.includes("yellow")) {
	      ctxPeg.fillStyle = "yellow";
	  }

	  ctxPeg.beginPath();
	  ctxPeg.arc(20, 10, 7, 0, 2 * Math.PI, false);
	  ctxPeg.fill();
	  ctxPeg.strokeStyle = 'black';
	  ctxPeg.stroke();
      }
      
      var iqtwist = null;

      var colorMapping = {
	  'R': "red",
	  'r': "red",
	  'G': "green",
	  'g': "green",
	  'Y': "yellow",
	  'y': "yellow",
	  'B': "blue",
	  'b': "blue"
      };

      let rowMapping = {
	  "a": 0,
	  "b": 1,
	  "c": 2,
	  "d": 3
      };
      
      onRuntimeInitialized: function placePegs() {

	  console.log("placing pegs...");

	  ctx.clearRect(0, 0, canvas.width, canvas.height);
	  pctx.clearRect(0, 0, pcanvas.width, pcanvas.height);
	  
	  if (iqtwist != null ) {
	      iqtwist.delete();
	      iqtwist = null;
	  }
	  
	  const start = Date.now();

	  var pegcmd = "";
	  let pegcmds = document.getElementsByClassName("pegcmd");
	  let pegSet = new Set();
	  
	  for (var i = 0; i < pegcmds.length; i++) {
	      
	      let cmd = pegcmds[i].value;

	      if (cmd != "") {
		  console.assert(cmd.length == 2);
		  console.assert("abcd".includes(cmd[0].toLowerCase()));
		  console.assert("12345678".includes(cmd[1]));

		  var color;
		  let pegId = pegcmds[i].id;
		  if (pegId.includes("red") ) {
		      color = 'r';
		  }
		  else if (pegId.includes("blue")) {
		      color = 'b';
		  }
		  else if (pegId.includes("green")) {
		      color = 'g';
		  }
		  else if (pegId.includes("yellow")) {
		      color = 'y';
		  }

		  let row = rowMapping[cmd[0].toLowerCase()];
		  let col = parseInt(cmd[1]) - 1;

		  pctx.fillStyle = colorMapping[color];
		  pctx.beginPath();
		  pctx.arc(col + 0.5, row + 0.5, 0.15, 0, 2 * Math.PI, false);
		  pctx.fill();
		  
		  pctx.strokeStyle = 'black';
		  pctx.lineWidth = 0.05;
		  pctx.stroke();
		  
		  var extraCmd = `-${color}${row}${col}`;

		  console.assert(!pegSet.has(extraCmd), "Peg location already used")
		  pegSet.add(extraCmd);

		  if (pegcmd == "") {
		      pegcmd = extraCmd;
		  }
		  else {
		      pegcmd += ` ${extraCmd}`;
		  }
	      }
	  }

	  iqtwist = new Module.IqTwist(pegcmd);
	  var nsolutions = iqtwist.search();
	  
	  document.getElementById("nsolutions").textContent = nsolutions;
	  document.getElementById("solutionIdx").value = (nsolutions > 0) ? 1 : 0;

	  console.log("Pegs placed");
	  console.log(`-- nsolutions: ${nsolutions}, time: ${(Date.now() - start) / 1000}s`)
      }

      onRuntimeInitialized: function solve() {

	  if (iqtwist == null) {
	      placePegs()
	  }
	  
	  let solutionIdx = parseInt(document.getElementById("solutionIdx").value);
	  
	  console.assert(solutionIdx >= 1)
	  console.assert(solutionIdx <= iqtwist.solution_count(), "select between " + 1 + " and " + iqtwist.solution_count())

	  if ((iqtwist.solution_count() > 0) && (solutionIdx <= iqtwist.solution_count()) && (solutionIdx > 0)) {
	      let solution = iqtwist.get_solution(solutionIdx - 1);

	      console.log("Solution: " + solution);
	      
	      for (var i = 0; i < 4; i++) {
		  for (var j = 0; j < 8; j++) {
		      ctx.fillStyle = colorMapping[solution.charAt(8*i + j)];
		      ctx.fillRect(j, i, 1, 1);
		      
		      // borders
		      ctx.fillStyle = 'black';
		      
		      // left border
		      if (j > 0) {
			  if (solution.charAt(8*i + j) != solution.charAt(8*i + j - 1)) {
			      ctx.fillRect(j, i, 0.05, 1);
			  }
		      }
		      // top border
		      if (i > 0) {
			  if (solution.charAt(8*i + j) != solution.charAt(8*(i-1) + j)) {
			      ctx.fillRect(j, i, 1, 0.05);
			  }
		      }
		  }
		  
	      }
	  }
      }
      
      
    </script>
    <script src="bindings.js"></script>
  </body>
</html>
